<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>models.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>models.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>The module with definitions of the models.
This file provides the definitions to construct every model.
This file is to be imported as a module and exports the following:</p>
<pre><code>NL - A model for Negative Learning
    Restricted Boltzmann Machine
ABC - A model for Autoencoding Binary Classifier
CapsNet4AD_Prototype - A prototype of Capsule Network 
    for Anomaly Detection
CapsNet4HAM - A Capsule Network for HAM10000 dataset
CapsNet4AD - A Capsule Network for other datasets
onehot - Performs a one-hot encoding 
    of nucleotide sequence
correct_order - Reshapes the one-hot 
    encoding array u to (4, length of string)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">einops</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">capsules.capsules</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Conv2d</span><span class="p">,</span> <span class="n">ReLU</span><span class="p">,</span> <span class="n">ELU</span><span class="p">,</span> <span class="n">LeakyReLU</span><span class="p">,</span> <span class="n">Conv1d</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">Linear</span><span class="p">,</span> <span class="n">Tanh</span><span class="p">,</span> <span class="n">Sigmoid</span><span class="p">,</span> <span class="n">MSELoss</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>A model for Negative Learning - Restricted Boltzmann Machine.
Adapted from https://github.com/eugenet12/pytorch-rbm-autoencoder</p>
<hr />
<p>&hellip;
Attributes</p>
<hr />
<p>momentum_coef : float
    coefficient for momentum
weight_decay : float
    coefficient for weight decay
W : Tensor of (size v_size, h_size)
    weights for the RBM
h_bias : Tensor
    bias for the hidden layer
v_bias : Tensor
    bias for the visible layer
W_momentum : Tensor
    momentum for weights
h_bias_momentum : Tensor
    momentum for hidden layer
v_bias_momentum : Tensor
    momentum for visible layer
k : int
    number of Gibbs samples
mse : MSELoss
    class to compute the loss
lr : float
    learning rate</p>
<h2>Methods</h2>
<p>sample_h(self, v)<br />
    Gibbs sampling for hidden layer
sample_v(self, h)
    Gibbs sampling for visible layer
update(self, v0, vk, ph0, phk, sign)
    Update the weights according to the CD formula
forward(self, x)
    Computes forward pass for the RBM
training_step(self, train_batch, batch_idx)
    Computes training step for the RBM with a positive
    learning phase and negative learning phase
validation_step(self, val_batch, batch_idx)
    Computes validation step for the RBM</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">NL</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> 
        <span class="n">h_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">momentum_coef</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">2e-4</span><span class="p">,</span>  <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">v_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momentum_coef</span> <span class="o">=</span> <span class="n">momentum_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">=</span> <span class="n">weight_decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">v_size</span><span class="p">,</span> <span class="n">h_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">h_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">v_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_momentum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">v_size</span><span class="p">,</span> <span class="n">h_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bias_momentum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">h_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bias_momentum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">v_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Gibbs sampling for hidden layer.
v - results of visible layer.
Returns results of hidden layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">v</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_bias</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">p</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Gibbs sampling for visible layer.
h - results of hidden layer.
Returns results of visible layer.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">h</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">t</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_bias</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Updates the weights according to the CD formula.
v0 - previous results of visible layer.
vk - new results of visible layer.
ph0 - previous results of hidden layer.
phk - new results of hidden layer.
sign - the sign, 1 for positive learning, -1 for negative learning.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">vk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span><span class="p">,</span> <span class="n">sign</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">W_momentum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_momentum</span> <span class="o">+=</span> <span class="n">sign</span><span class="o">*</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">t</span><span class="p">()</span> <span class="o">@</span> <span class="n">ph0</span> <span class="o">-</span> <span class="n">vk</span><span class="o">.</span><span class="n">t</span><span class="p">()</span> <span class="o">@</span> <span class="n">phk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bias_momentum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bias_momentum</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ph0</span> <span class="o">-</span> <span class="n">phk</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bias_momentum</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bias_momentum</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v0</span> <span class="o">-</span> <span class="n">vk</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">W_momentum</span><span class="o">/</span><span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bias</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">h_bias_momentum</span><span class="o">/</span><span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bias</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_bias_momentum</span><span class="o">/</span><span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Computes forward pass for the RBM.
x - input data.
Outputs values of visible and hidden layer.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">v0</span><span class="p">,</span> <span class="n">pvk</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">hk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_h</span><span class="p">(</span><span class="n">pvk</span><span class="p">)</span>
            <span class="n">pvk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_v</span><span class="p">(</span><span class="n">hk</span><span class="p">)</span>
        <span class="n">ph0</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_h</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
        <span class="n">phk</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_h</span><span class="p">(</span><span class="n">pvk</span><span class="p">)</span>
        <span class="n">pvk</span> <span class="o">=</span> <span class="n">pvk</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">ph0</span> <span class="o">=</span> <span class="n">ph0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">phk</span> <span class="o">=</span> <span class="n">phk</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pvk</span> <span class="o">=</span> <span class="n">pvk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ph0</span> <span class="o">=</span> <span class="n">ph0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">phk</span> <span class="o">=</span> <span class="n">phk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pvk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Computes training step for the RBM with a positive
learning phase and negative learning phase.
Outputs positive and negative losses.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">train_batch</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">p_loss</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pvk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pvk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">p_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pvk</span><span class="p">)</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pvk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pvk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span><span class="p">,</span> <span class="n">sign</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">n_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pvk</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">p_loss</span><span class="p">,</span> <span class="n">n_loss</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Computes validation step for the RBM.
Outputs positive and negative losses.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">val_batch</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">pvk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">p_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pvk</span><span class="p">)</span>
        <span class="n">pvk</span><span class="p">,</span> <span class="n">ph0</span><span class="p">,</span> <span class="n">phk</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">n_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pvk</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">p_loss</span><span class="p">,</span> <span class="n">n_loss</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <h2>A model for Autoencoding Binary Classifier</h2>
<p>&hellip;
Attributes</p>
<hr />
<p>encoder : torch.nn.Sequential
    module for the encoding part
decoder : torch.nn.Sequential
    module for the decoding part
mse : MSELoss
    module for computing the loss</p>
<h2>Methods</h2>
<p>configure_optimizers(self)
    Configures the optimizer for the ABC
forward(self, x)
    Computes forward pass for the ABC
loss(self, x, x_hat, y)
    Computes the ABC loss
training_step(self, train_batch, batch_idx)
    Computes training step for the ABC
validation_step(self, val_batch, batch_idx)
    Computes validation step for the ABC</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">ABC</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="n">hiddens</span><span class="o">=</span><span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">z_size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">(</span>
            <span class="n">Linear</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">input_shape</span><span class="p">),</span> <span class="n">hiddens</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">Tanh</span><span class="p">(),</span>
            <span class="n">Linear</span><span class="p">(</span><span class="n">hiddens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hiddens</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">Tanh</span><span class="p">(),</span>
            <span class="n">Linear</span><span class="p">(</span><span class="n">hiddens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z_size</span><span class="p">),</span>
            <span class="n">Tanh</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">(</span>
            <span class="n">Linear</span><span class="p">(</span><span class="n">z_size</span><span class="p">,</span> <span class="n">hiddens</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">Tanh</span><span class="p">(),</span>
            <span class="n">Linear</span><span class="p">(</span><span class="n">hiddens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hiddens</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">Tanh</span><span class="p">(),</span>
            <span class="n">Linear</span><span class="p">(</span><span class="n">hiddens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)),</span>
            <span class="n">Sigmoid</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Computes forward pass for the ABCs.
x - input data.
Outputs the reconstruction.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">ss</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">x_hat</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Configures the optimizer (default Adam).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="k">return</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Computes the ABC loss.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">mse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">x_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">mse</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">mse</span><span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Computes validation step for the ABC.
Outputs the loss.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">train_batch</span>
        <span class="n">x_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
            <span class="n">x_hat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Computes validation step for the ABC.
Outputs the loss.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">val_batch</span>
        <span class="n">x_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
            <span class="n">x_hat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <h2>A prototype of Capsule Network for Anomaly Detection</h2>
<p>&hellip;
Attributes</p>
<hr />
<p>No attributes - they are to be defined 
    in the descendant classes</p>
<h2>Methods</h2>
<p>configure_optimizers(self)
    Configures the optimizer for the CapsNet
forward(self, x)
    Computes forward pass for the CapsNet
capsule_loss(self, real_class, x, classes, reconstruction)
    Computes the margin loss
training_step(self, train_batch, batch_idx)
    Computes training step for the CapsNet
validation_step(self, val_batch, batch_idx)
    Computes validation step for the CapsNet</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">CapsNet4AD_Prototype</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CapsNet4AD_Prototype</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Compute forward of capsules, get the longest vectors,</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">reconstruct</span> <span class="n">the</span> <span class="n">pictures</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        u = self.conv(x)</span>
<span class="s2">        u = self.primcaps(u)</span>
<span class="s2">        internal, a = self.digicaps(u)</span>
<span class="s2">        lengths = (internal**2).sum(dim=-1)**0.5</span>
<span class="s2">        _, max_caps_index = lengths.max(dim=-1)</span>
<span class="s2">        masked = torch.eye(self.n_classes)</span>
<span class="s2">        masked = masked.cuda() if torch.cuda.is_available() else masked</span>
<span class="s2">        masked = masked.index_select(dim=0, index=max_caps_index)</span>
<span class="s2">        reconstruction = self.decoder(</span>
<span class="s2">            (internal*masked[:,:,None]).reshape(x.size(0), -1)</span>
<span class="s2">        )</span>
<span class="s2">        return(internal, reconstruction, lengths, max_caps_index, a)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    def configure_optimizers(self):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="n">Configures</span> <span class="n">the</span> <span class="n">optimizer</span> <span class="p">(</span><span class="n">default</span> <span class="n">Adam</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        optimizer = Adam(self.parameters())</span>
<span class="s2">        return(optimizer)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    def capsule_loss(self, real_class, x, classes, reconstruction):</span>
<span class="s2">#DIVIDER</span>
<span class="s2">        return(</span>
<span class="s2">            self.capsule_loss_object(</span>
<span class="s2">                real_class, x.reshape(x.shape[0], -1),</span>
<span class="s2">                classes, reconstruction</span>
<span class="s2">            )</span>
<span class="s2">        )</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    def training_step(self, train_batch, batch_idx):</span>
<span class="s2">#DIVIDER</span>
<span class="s2">        x, y = train_batch</span>
<span class="s2">        real_class = make_y(y.type(torch.LongTensor).cuda(), self.n_classes)</span>
<span class="s2">        internal, reconstruction, classes, max_index, _ = self.forward(x)</span>
<span class="s2">        loss = self.capsule_loss(</span>
<span class="s2">            real_class, x, classes, reconstruction</span>
<span class="s2">        )</span>
<span class="s2">        self.log(&quot;train_loss&quot;, loss)</span>
<span class="s2">        return(loss)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    def validation_step(self, val_batch, batch_idx):</span>
<span class="s2">#DIVIDER</span>
<span class="s2">        x, y = val_batch</span>
<span class="s2">        real_class = make_y(y.type(torch.LongTensor).cuda(), self.n_classes)</span>
<span class="s2">        internal, reconstruction, classes, max_index, _ = self.forward(x)</span>
<span class="s2">        loss = self.capsule_loss(</span>
<span class="s2">            real_class, x, classes, reconstruction</span>
<span class="s2">        )</span>
<span class="s2">        self.log(&quot;val_loss&quot;, loss)</span>
<span class="s2">        return(loss)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">class CapsNet4HAM(CapsNet4AD_Prototype):</span>
<span class="s2">#DIVIDER</span>

<span class="s2">#DIVIDER</span>
<span class="s2">    def __init__(self, n_primary: int = 20736, rec_size: int = 22500, n_classes: int = 2):</span>
<span class="s2">        super().__init__()</span>
<span class="s2">        self.conv = Sequential(</span>
<span class="s2">            Conv2d(</span>
<span class="s2">                in_channels=3,</span>
<span class="s2">                out_channels=256,</span>
<span class="s2">                kernel_size=9,</span>
<span class="s2">                stride=1</span>
<span class="s2">            ),</span>
<span class="s2">            ELU(inplace=True)</span>
<span class="s2">        )</span>
<span class="s2">        self.n_classes = n_classes</span>
<span class="s2">        self.primcaps = PrimaryCapsuleLayer()</span>
<span class="s2">        self.digicaps = SecondaryCapsuleLayer(</span>
<span class="s2">            n_capsules=n_classes, return_couplings=True, n_primary=n_primary</span>
<span class="s2">        )</span>
<span class="s2">        self.decoder = RegularizingDecoder(dims=[32,512,1024,rec_size])</span>
<span class="s2">        self.capsule_loss_object = CapsuleLoss(</span>
<span class="s2">            only_normals=True, normal_class=0</span>
<span class="s2">        )</span>
<span class="s2">#DIVIDER</span>
<span class="s2">class CapsNet4AD(CapsNet4AD_Prototype):</span>
<span class="s2">#DIVIDER</span>

<span class="s2">#DIVIDER</span>
<span class="s2">    def __init__(</span>
<span class="s2">        self, n_primary: int = 1152, in_channels: int = 1, </span>
<span class="s2">        rec_size: int = 28*28, kernel_size: int = 9, primcaps_kernel_size: int = 9,</span>
<span class="s2">        n_classes: int = 2</span>
<span class="s2">    ):</span>
<span class="s2">        super().__init__()</span>
<span class="s2">        self.conv = Sequential(</span>
<span class="s2">            Conv2d(</span>
<span class="s2">                in_channels=in_channels,</span>
<span class="s2">                out_channels=256,</span>
<span class="s2">                kernel_size=kernel_size,</span>
<span class="s2">                stride=1</span>
<span class="s2">            ),</span>
<span class="s2">            ReLU(inplace=True)</span>
<span class="s2">        )</span>
<span class="s2">        self.primcaps = PrimaryCapsuleLayer(</span>
<span class="s2">            n_convs=32, out_ch=32, kernel_size=primcaps_kernel_size</span>
<span class="s2">        )</span>
<span class="s2">        self.digicaps = SecondaryCapsuleLayer(</span>
<span class="s2">            n_capsules=n_classes, return_couplings=True, n_primary=n_primary,</span>
<span class="s2">            in_ch=32</span>
<span class="s2">        )</span>
<span class="s2">        self.n_classes = n_classes</span>
<span class="s2">        self.decoder = RegularizingDecoder(dims=[16*n_classes,512,1024,rec_size])</span>
<span class="s2">        self.capsule_loss_object = CapsuleLoss(</span>
<span class="s2">            only_normals=True, normal_class=0</span>
<span class="s2">        )</span>
<span class="s2">#DIVIDER</span>
<span class="s2">def onehot(u):</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    encoding = {</span>
<span class="s2">        1: [1,0,0,0],</span>
<span class="s2">        2: [0,0,0,1],</span>
<span class="s2">        3: [0,1,0,0],</span>
<span class="s2">        4: [0,0,1,0],</span>
<span class="s2">        0: [0,0,0,0],</span>
<span class="s2">        &quot;A&quot;: [1,0,0,0],</span>
<span class="s2">        &quot;T&quot;: [0,0,0,1],</span>
<span class="s2">        &quot;G&quot;: [0,1,0,0],</span>
<span class="s2">        &quot;C&quot;: [0,0,1,0],</span>
<span class="s2">        &quot;N&quot;: [0,0,0,0],</span>
<span class="s2">        &quot;a&quot;: [1,0,0,0],</span>
<span class="s2">        &quot;t&quot;: [0,0,0,1],</span>
<span class="s2">        &quot;g&quot;: [0,1,0,0],</span>
<span class="s2">        &quot;c&quot;: [0,0,1,0],</span>
<span class="s2">        &quot;n&quot;: [0,0,0,0]</span>
<span class="s2">    }</span>
<span class="s2">    r = np.array(sum([encoding[a] for a in u], []))</span>
<span class="s2">    return(r)</span>
<span class="s2">#DIVIDER</span>
<span class="s2">def correct_order(u, k=4):</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    return(</span>
<span class="s2">        u.reshape((k,int(u.shape[0]/k)), order=&quot;f&quot;).reshape(u.shape[0])</span>
<span class="s2">    )</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Computes margin loss</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>Computes training step for the CapsNet.
Outputs the loss.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Computes validation step for the CapsNet.
Outputs the loss.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <h2>A Capsule Network for HAM10000 dataset</h2>
<p>&hellip;
Attributes</p>
<hr />
<p>conv : torch.nn.Sequential
    A module for the convolutional 
    preprocessing
n_classes : int
    number of classes
primcaps : Primary Capsule layer
digicaps : Secondary Capsule layer
decoder : Regularizing decoder
capsule_loss_object : the object for 
    Margin Loss</p>
<h2>Methods</h2>
<p>No methods but the ones that 
    were defined in prototype</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <h2>A Capsule Network for other datasets</h2>
<p>&hellip;
Attributes</p>
<hr />
<p>conv : torch.nn.Sequential
    A module for the convolutional 
    preprocessing
n_classes : int
    number of classes
primcaps : Primary Capsule layer
digicaps : Secondary Capsule layer
decoder : Regularizing decoder
capsule_loss_object : the object for
    Margin Loss</p>
<h2>Methods</h2>
<p>No methods but the ones that 
    were defined in prototype</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Performs a one-hot encoding of nucleotide sequence</p>
<p>u is the input string</p>
<p>Outputs a 1D numpy array with the encoding </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Reshapes the one-hot encoding array u to (4, length of string)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
